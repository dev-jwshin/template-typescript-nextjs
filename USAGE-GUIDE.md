# 사용자 인증 시스템 사용 가이드

이 가이드는 구현된 회원가입/로그인/내정보 확인/유저 리스트 기능의 사용법을 설명합니다.

## 🚀 빠른 시작

### 1. 환경 변수 설정

프로젝트 루트에 `.env.local` 파일을 생성하고 다음 내용을 추가하세요:

```bash
NEXT_PUBLIC_API_URL=http://localhost:3001
```

### 2. 개발 서버 실행

```bash
npm run dev
```

브라우저에서 `http://localhost:3000`으로 접속하세요.

## 📱 기능별 사용법

### 1. 메인 페이지 (`/`)

- **로그인되지 않은 상태**: 로그인/회원가입 버튼이 표시됩니다
- **로그인된 상태**: 자동으로 대시보드(`/dashboard`)로 리디렉션됩니다

### 2. 회원가입 (`/auth/signup`)

**필수 입력 필드:**
- 이름 (2-50글자)
- 이메일 (유효한 이메일 형식)
- 비밀번호 (8글자 이상, 영문+숫자 포함)
- 비밀번호 확인

**선택 입력 필드:**
- 전화번호 (010-0000-0000 형식)

**검증 규칙:**
- 이름: 최소 2글자, 최대 50글자
- 이메일: 올바른 이메일 형식
- 비밀번호: 최소 8글자, 영문과 숫자 포함 필수
- 전화번호: 010-0000-0000 형식 (선택)

### 3. 로그인 (`/auth/signin`)

**입력 필드:**
- 이메일
- 비밀번호

**동작:**
- 성공 시 대시보드로 자동 이동
- 실패 시 에러 메시지 표시

### 4. 대시보드 (`/dashboard`)

**표시 정보:**
- 사용자 환영 메시지
- 계정 정보 요약 (이메일, 권한, 가입일)
- 빠른 액션 버튼들

**권한별 기능:**
- **일반 사용자**: 내 정보 관리만 가능
- **관리자**: 사용자 관리 기능 추가 제공

### 5. 내 정보 (`/profile`)

**조회 모드:**
- 이름, 이메일, 전화번호, 권한, 계정 상태, 가입 방법, 가입일, 최종 수정일

**수정 모드:**
- 이름 수정 가능
- 전화번호 수정 가능
- 이메일은 수정 불가

**기능:**
- ✏️ 수정 버튼: 수정 모드로 전환
- 💾 저장 버튼: 변경사항 저장  
- ❌ 취소 버튼: 변경사항 취소
- 🚪 로그아웃 버튼: 로그아웃 및 로그인 페이지로 이동

### 6. 사용자 목록 (`/users`)

**표시 정보:**
- 모든 사용자의 이름, 이메일, 전화번호, 권한, 상태, 가입방법, 가입일

**필터링:**
- 이메일로 검색 가능 (LIKE 패턴 - 부분 일치)
- @foryourdev/nestjs-crud 방식: `filter[email_like]=%검색어%`
- 검색 버튼으로 필터 적용
- 초기화 버튼으로 필터 제거
- ⚠️ 현재 백엔드에서는 email 필드만 필터링 허용

**페이지네이션:**
- 페이지당 10명씩 표시
- 이전/다음 버튼
- 페이지 번호 직접 클릭

**권한:**
- 모든 인증된 사용자가 조회 가능
- 관리자는 추가적인 관리 기능 (향후 확장 예정)

## 🔐 인증 및 권한

### 자동 토큰 관리

- **Access Token**: 15분 유효, 메모리에 저장
- **Refresh Token**: 7일 유효, localStorage에 저장
- **자동 갱신**: 401 에러 시 자동으로 토큰 갱신 시도

### 권한 시스템

- **user (일반 사용자)**: 기본 권한, 내 정보만 관리 가능
- **admin (관리자)**: 모든 사용자 정보 조회 및 관리 가능

### 보안 기능

- 페이지 접근 권한 검사
- 자동 로그아웃 (토큰 만료 시)
- 비인증 사용자 자동 리디렉션

## 🧪 테스트 시나리오

### 1. 회원가입 테스트

```
1. /auth/signup 접속
2. 필수 정보 입력:
   - 이름: "테스트 사용자"
   - 이메일: "test@example.com"
   - 비밀번호: "password123"
   - 비밀번호 확인: "password123"
3. 회원가입 버튼 클릭
4. 성공 시 대시보드로 자동 이동 확인
```

### 2. 로그인 테스트

```
1. /auth/signin 접속
2. 가입한 계정 정보 입력:
   - 이메일: "test@example.com"
   - 비밀번호: "password123"
3. 로그인 버튼 클릭
4. 성공 시 대시보드로 자동 이동 확인
```

### 3. 내 정보 수정 테스트

```
1. /profile 접속
2. "수정" 버튼 클릭
3. 이름 또는 전화번호 변경
4. "저장" 버튼 클릭
5. 변경사항 반영 확인
```

### 4. 사용자 목록 테스트

```
1. /users 접속
2. 사용자 목록 표시 확인
3. 이메일 검색 기능 테스트:
   - 검색어 입력: "test"
   - 검색 버튼 클릭
   - 필터링된 결과 확인
4. 페이지네이션 테스트 (사용자가 10명 이상인 경우)
```

### 5. 권한 테스트

```
1. 일반 사용자 계정으로 로그인
2. 대시보드에서 사용자 관리 카드 미표시 확인
3. 관리자 계정으로 로그인 (있는 경우)
4. 대시보드에서 사용자 관리 카드 표시 확인
```

## 🐛 문제 해결

### 자주 발생하는 문제

1. **로그인 후 빈 화면이 표시되는 경우**
   - 브라우저 콘솔에서 에러 확인
   - localStorage에 토큰이 저장되었는지 확인
   - 페이지 새로고침 시도

2. **API 호출 실패**
   - `.env.local` 파일의 `NEXT_PUBLIC_API_URL` 확인
   - 백엔드 서버가 실행 중인지 확인
   - 네트워크 탭에서 실제 요청 URL 확인

3. **토큰 만료 에러**
   - 자동으로 토큰 갱신 시도됨
   - 갱신 실패 시 자동 로그아웃됨
   - 다시 로그인하면 정상 동작

4. **폼 검증 에러**
   - 각 필드의 검증 규칙 확인
   - 에러 메시지 내용 확인
   - 필수 필드 누락 여부 확인

### 개발자 도구 활용

1. **Network 탭**: API 요청/응답 확인
2. **Console 탭**: JavaScript 에러 확인  
3. **Application 탭**: localStorage의 토큰 확인
4. **Elements 탭**: DOM 구조 및 CSS 확인

## 🔍 필터링 시스템 상세 가이드

### @foryourdev/nestjs-crud 필터링 방식

이 프로젝트는 **underscore 구분자 방식**을 사용합니다:

```bash
# ✅ 올바른 형식
GET /users?filter[email_like]=%gmail.com%
GET /users?filter[email_eq]=test@example.com

# ❌ 지원하지 않는 형식
GET /users?filter[email][$like]=%gmail.com%    # 작동하지 않음
GET /users?filter=email||$cont||gmail          # 작동하지 않음
```

### 사용 가능한 필터 연산자

현재 **email 필드만 필터링 허용**되며, 사용 가능한 연산자:

- `email_eq`: 정확히 일치
- `email_ne`: 일치하지 않음
- `email_like`: LIKE 패턴 (`%`를 사용한 와일드카드)
- `email_start`: 시작 문자열
- `email_end`: 끝 문자열
- `email_in`: 여러 값 중 하나 (콤마로 구분)
- `email_null`: NULL 값
- `email_not_null`: NOT NULL

### 코드에서 필터 사용하기

```tsx
// 1. apiUtils 헬퍼 사용 (권장)
const emailQuery = apiUtils.emailFilter('gmail.com')
// 결과: { filter: { email_like: '%gmail.com%' } }

// 2. 직접 필터 생성
const customFilter = {
  filter: {
    email_eq: 'test@example.com'
  }
}

// 3. 사용자 목록 훅에서 사용
const { data: users } = useUsers(emailQuery)
```

## 📚 추가 기능 확장 가이드

### 새로운 API 엔드포인트 추가

1. `lib/constants.ts`에 엔드포인트 추가
2. `types/api.ts`에 관련 타입 정의
3. `hooks/use-api.ts`에 커스텀 훅 생성
4. 컴포넌트에서 훅 사용

### 새로운 필터 추가 (백엔드 설정 필요)

백엔드에서 `allowedFilters`에 새 필드를 추가한 후:

```tsx
// lib/api.ts에 새 헬퍼 함수 추가
nameFilter(value: string): Record<string, unknown> {
  return {
    filter: {
      name_like: `%${value}%`
    }
  }
}

// 컴포넌트에서 사용
const nameQuery = apiUtils.nameFilter('홍길동')
const { data: users } = useUsers(nameQuery)
```

### 새로운 페이지 추가

1. `app/` 디렉토리에 페이지 생성
2. 필요한 컴포넌트를 `components/` 디렉토리에 생성
3. 인증이 필요한 페이지의 경우 `useAuth` 훅으로 권한 검사

### 권한 시스템 확장

1. `types/api.ts`에서 `User` 타입의 `role` 확장
2. `store/auth-store.ts`의 `usePermissions` 훅 수정
3. 컴포넌트에서 새로운 권한 검사 로직 적용

이 가이드를 따라하면 전체 시스템을 정확히 이해하고 사용할 수 있습니다! 🎉 